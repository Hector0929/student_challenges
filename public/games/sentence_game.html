<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentence Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'DotGothic16', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .pixel-font {
            font-family: 'DotGothic16', sans-serif;
        }

        .card-slot {
            min-height: 80px;
            background-color: #ebf8ff;
            border: 2px dashed #4299e1;
            border-radius: 1rem;
            transition: all 0.3s;
        }

        .word-card {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 4px 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
            cursor: move;
            font-weight: bold;
            color: #2d3748;
            user-select: none;
            touch-action: manipulation;
            -webkit-user-drag: none;
        }

        .word-card:active {
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            transform: scale(0.98);
        }

        .ghost {
            opacity: 0.5;
            background: #e2e8f0;
        }

        .clay-btn {
            border-radius: 1rem;
            box-shadow: 4px 4px 8px #d1d9e6, -4px -4px 8px #ffffff;
            transition: all 0.2s;
        }

        .clay-btn:active {
            transform: scale(0.95);
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
        }
    </style>
</head>

<body class="bg-blue-50 min-h-screen flex flex-col items-center justify-start">

    <div class="w-full max-w-2xl px-4 flex flex-col gap-5 h-full min-h-[100dvh] py-4 sm:py-6">

        <!-- Header -->
        <div class="flex justify-between items-center">
            <div class="bg-white px-6 py-2 rounded-xl shadow-sm flex items-center gap-2 border border-blue-100">
                <span class="text-2xl">‚≠ê</span>
                <span id="score" class="text-xl text-blue-800 font-bold">0</span>
            </div>
            <button onclick="playTargetSentence()"
                class="bg-blue-100 hover:bg-blue-200 text-blue-600 px-4 py-2 rounded-xl text-sm flex items-center gap-2 transition-colors">
                üîä ËÅΩÂè•Â≠ê
            </button>
        </div>

        <!-- Target / Hint Area -->
        <div class="bg-white rounded-2xl p-6 shadow-md border-2 border-blue-100 text-center">
            <p class="text-gray-500 mb-2 text-sm">Ë´ãÈáçÁµÑÂè•Â≠êÔºö</p>
            <h2 id="translation" class="text-2xl text-blue-900 font-bold mb-4">ÈÄôÊòØ‰∏ÄÈ°ÜËòãÊûú„ÄÇ</h2>

            <!-- Construction Area -->
            <div id="construct-area"
                class="card-slot flex flex-wrap gap-2 items-center justify-center p-4 min-h-[100px]">
                <!-- Cards dropped here -->
            </div>
        </div>

        <!-- Source Area -->
        <div class="flex-1 flex flex-col justify-end">
            <p class="text-center text-gray-500 mb-2 text-sm">ÂèØÁî®ÂñÆÂ≠óÂç°Ôºö</p>
            <div id="source-area"
                class="flex flex-wrap gap-3 justify-center bg-blue-100/50 p-6 rounded-2xl min-h-[120px]">
                <!-- Initial cards -->
            </div>
        </div>

        <!-- Check Button -->
        <button onclick="checkAnswer()"
            class="clay-btn bg-green-500 text-white py-4 text-xl font-bold hover:bg-green-600 transition-colors w-full shadow-lg">
            ‚úÖ ÈÄÅÂá∫Á≠îÊ°à
        </button>

    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center pointer-events-none">
        <div class="bg-white shadow-2xl rounded-2xl px-8 py-4 border-4 border-green-200 animate-bounce">
            <span class="text-4xl">üéâ Correct!</span>
        </div>
    </div>

    <script>
        const SENTENCES = [
            { en: "This is an apple", zh: "ÈÄôÊòØ‰∏ÄÈ°ÜËòãÊûú", audio: "This is an apple" },
            { en: "I like ice cream", zh: "ÊàëÂñúÊ≠°ÂÜ∞Ê∑áÊ∑ã", audio: "I like ice cream" },
            { en: "The cat is sleeping", zh: "Ë≤ìÂí™Ê≠£Âú®Áù°Ë¶∫", audio: "The cat is sleeping" },
            { en: "She has a red ball", zh: "Â•πÊúâ‰∏ÄÈ°ÜÁ¥ÖËâ≤ÁöÑÁêÉ", audio: "She has a red ball" },
            { en: "He can run fast", zh: "‰ªñÂèØ‰ª•Ë∑ëÂæàÂø´", audio: "He can run fast" },
            { en: "Where is the dog", zh: "ÁãóÁãóÂú®Âì™Ë£°", audio: "Where is the dog" },
            { en: "My name is John", zh: "ÊàëÁöÑÂêçÂ≠óÊòØ John", audio: "My name is John" }
        ];

        let currentSortables = [];
        let state = {
            currentLevel: 0,
            score: 0,
            currentSentence: null,
            sentences: SENTENCES // Will be replaced with custom sentences if available
        };

        // Try to load custom sentences from localStorage
        function loadCustomSentences() {
            try {
                const customData = localStorage.getItem('customSentences');
                if (customData) {
                    const parsed = JSON.parse(customData);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        // Convert to game format
                        state.sentences = parsed.map(s => ({
                            en: s.en,
                            zh: s.zh,
                            audio: s.en
                        }));
                        console.log('Loaded', state.sentences.length, 'custom sentences');
                    }
                }
            } catch (e) {
                console.warn('Failed to load custom sentences:', e);
            }
        }

        // Preload voices for better TTS
        let voicesReady = false;
        function ensureVoices() {
            return new Promise((resolve) => {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voicesReady = true;
                    resolve(voices);
                } else {
                    window.speechSynthesis.onvoiceschanged = () => {
                        voicesReady = true;
                        resolve(window.speechSynthesis.getVoices());
                    };
                    // Fallback timeout
                    setTimeout(() => {
                        voicesReady = true;
                        resolve(window.speechSynthesis.getVoices());
                    }, 500);
                }
            });
        }

        // Sortable instances
        let sourceSortable, targetSortable;

        async function init() {
            // Preload voices first
            await ensureVoices();

            // Initialize Sortable based on IDs
            const sourceEl = document.getElementById('source-area');
            const targetEl = document.getElementById('construct-area');

            sourceSortable = new Sortable(sourceEl, {
                group: 'shared',
                animation: 150,
                ghostClass: 'ghost',
                forceFallback: true,
                fallbackTolerance: 3,
                delayOnTouchOnly: true,
                delay: 60,
                touchStartThreshold: 5
            });

            targetSortable = new Sortable(targetEl, {
                group: 'shared',
                animation: 150,
                ghostClass: 'ghost',
                forceFallback: true,
                fallbackTolerance: 3,
                delayOnTouchOnly: true,
                delay: 60,
                touchStartThreshold: 5
            });

            // Load custom sentences if available
            loadCustomSentences();
            nextLevel();
        }

        function nextLevel() {
            // Pick random sentence from custom or default sentences
            const sentences = state.sentences;
            const idx = Math.floor(Math.random() * sentences.length);
            state.currentSentence = sentences[idx];

            // Update UI
            document.getElementById('translation').textContent = state.currentSentence.zh;

            // Prepare cards with shuffle
            const words = state.currentSentence.en.split(' ');
            const shuffled = [...words].sort(() => Math.random() - 0.5);

            // Render Cards
            const sourceEl = document.getElementById('source-area');
            const targetEl = document.getElementById('construct-area');

            sourceEl.innerHTML = '';
            targetEl.innerHTML = '';

            shuffled.forEach(word => {
                const card = document.createElement('div');
                card.className = 'word-card';
                card.textContent = word;
                card.dataset.word = word;
                sourceEl.appendChild(card);
            });

            playTargetSentence();
        }

        function playTargetSentence() {
            if (!state.currentSentence) return;
            window.speechSynthesis.cancel();

            const u = new SpeechSynthesisUtterance(state.currentSentence.en);
            const voices = window.speechSynthesis.getVoices();

            // Prefer high-quality voices (same as spelling_game.html)
            const preferredVoice = voices.find(v => v.name.includes('Samantha') || v.name.includes('Siri'))
                || voices.find(v => v.name.includes('Google US English'))
                || voices.find(v => v.lang.startsWith('en-US'))
                || voices.find(v => v.lang.startsWith('en'));

            if (preferredVoice) u.voice = preferredVoice;
            u.lang = 'en-US';
            u.rate = 0.85;
            window.speechSynthesis.speak(u);
        }

        function checkAnswer() {
            const targetEl = document.getElementById('construct-area');
            const cards = Array.from(targetEl.children);
            const playerSentence = cards.map(c => c.dataset.word).join(' ');

            // Clean up punctuation for comparison? Simple strict match for now
            // But user might assemble "This is an apple" vs "This is an apple." logic
            // Our data doesn't have punctuation in the split usually, but let's be safe.
            // Actually my data "This is an apple" has no period at end.

            if (playerSentence === state.currentSentence.en) {
                // Correct
                state.score += 10;
                document.getElementById('score').textContent = state.score;
                showFeedback(true);
                playSound('win');
                setTimeout(() => {
                    nextLevel();
                }, 1500);
            } else {
                // Wrong
                playSound('error');
                targetEl.classList.add('bg-red-50', 'border-red-300');
                setTimeout(() => targetEl.classList.remove('bg-red-50', 'border-red-300'), 500);
            }
        }

        function showFeedback(isCorrect) {
            const el = document.getElementById('feedback-modal');
            el.classList.remove('hidden');
            setTimeout(() => {
                el.classList.add('hidden');
            }, 1000);
        }

        function playSound(type) {
            // Simple synth sounds
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g);
            g.connect(ctx.destination);

            if (type === 'win') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, ctx.currentTime);
                osc.frequency.setValueAtTime(1000, ctx.currentTime + 0.1);
                g.gain.setValueAtTime(0.1, ctx.currentTime);
                g.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
                g.gain.setValueAtTime(0.1, ctx.currentTime);
                g.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
            }
        }

        init();
    </script>
</body>

</html>