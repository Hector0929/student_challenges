<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆèªå¤§æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            font-family: 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
        }

        body {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0.5rem;
            touch-action: manipulation;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            padding: 24px;
            max-width: 460px;
            width: 100%;
            position: relative;
            max-height: calc(100dvh - 1rem);
            overflow-y: auto;
        }

        /* Mode buttons */
        .mode-btn {
            padding: 16px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.2s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            cursor: pointer;
            border: 3px solid transparent;
        }
        .mode-btn:active { transform: translateY(3px); box-shadow: none; }

        /* Option buttons */
        .option-btn {
            padding: 14px 20px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1.05rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.08);
            cursor: pointer;
            border: 3px solid #e2e8f0;
            background: white;
            color: #1e293b;
            text-align: left;
            line-height: 1.4;
        }
        .option-btn:hover { border-color: #818cf8; background: #f0f0ff; }
        .option-btn:active { transform: translateY(3px); box-shadow: none; }
        .option-btn.correct {
            background: #dcfce7; border-color: #22c55e; color: #166534;
            animation: correctPulse 0.5s;
        }
        .option-btn.wrong {
            background: #fee2e2; border-color: #ef4444; color: #991b1b;
            animation: shake 0.4s;
        }
        .option-btn.reveal {
            background: #dbeafe; border-color: #3b82f6; color: #1e40af;
        }
        .option-btn.disabled { pointer-events: none; opacity: 0.6; }

        /* Fill-in blank character buttons */
        .char-btn {
            width: 52px; height: 52px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.3rem;
            transition: all 0.15s;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
            cursor: pointer;
            border: 2px solid #c7d2fe;
            background: #eef2ff;
            color: #3730a3;
            display: flex; align-items: center; justify-content: center;
        }
        .char-btn:hover { background: #c7d2fe; }
        .char-btn:active { transform: translateY(3px); box-shadow: none; }
        .char-btn.selected { background: #818cf8; color: white; border-color: #6366f1; }

        .blank-slot {
            width: 52px; height: 52px;
            border-radius: 12px;
            border: 3px dashed #a5b4fc;
            background: #f8fafc;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; font-weight: 700; color: #4338ca;
            cursor: pointer;
            transition: all 0.15s;
        }
        .blank-slot.filled { border-style: solid; background: #e0e7ff; }
        .blank-slot.correct { background: #dcfce7; border-color: #22c55e; color: #166534; }
        .blank-slot.wrong { background: #fee2e2; border-color: #ef4444; color: #991b1b; }

        /* Combo badge */
        .combo-badge {
            position: absolute; top: -12px; right: -8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #92400e; font-weight: 900; font-size: 1rem;
            padding: 6px 14px; border-radius: 50px;
            transform: scale(0); transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            border: 3px solid white; z-index: 10;
        }
        .combo-badge.visible { transform: scale(1); }

        /* Floating feedback */
        .float-text {
            position: fixed; left: 50%; top: 40%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem; font-weight: 900;
            pointer-events: none; z-index: 100;
            animation: floatUp 0.9s forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, 0) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -40px) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -120px) scale(1); }
        }
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.95); }
            100% { transform: scale(1); opacity: 1; }
        }
        .bounce-in { animation: bounceIn 0.4s ease-out; }

        /* Progress bar */
        .progress-track {
            height: 8px; background: #e2e8f0; border-radius: 99px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #818cf8, #6366f1);
            border-radius: 99px; transition: width 0.4s ease;
        }

        /* Stars display */
        .star { display: inline-block; font-size: 2rem; transition: all 0.3s; }
        .star.earned { animation: starPop 0.4s ease-out; }
        @keyframes starPop {
            0% { transform: scale(0); }
            60% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
    </style>
</head>

<body>
    <div class="game-container" id="main">
        <div class="combo-badge" id="combo-badge">COMBO x0</div>

        <!-- ===== START SCREEN ===== -->
        <div id="start-screen">
            <div class="text-center mb-6">
                <div class="text-6xl mb-3">ğŸ“œ</div>
                <h1 class="text-2xl font-black text-gray-800">æˆèªå¤§æŒ‘æˆ°</h1>
                <p class="text-gray-500 text-sm mt-1">å­¸æˆèªï¼Œè®Šè°æ˜ï¼</p>
            </div>

            <div class="space-y-3 mb-6">
                <button class="mode-btn w-full bg-indigo-100 text-indigo-800 hover:bg-indigo-200" onclick="startGame('meaning')">
                    ğŸ“– çœ‹è§£é‡‹çŒœæˆèª
                    <div class="text-xs font-normal mt-1 text-indigo-500">çœ‹æˆèªçš„æ„æ€ï¼Œé¸å‡ºæ­£ç¢ºçš„æˆèª</div>
                </button>
                <button class="mode-btn w-full bg-amber-100 text-amber-800 hover:bg-amber-200" onclick="startGame('fill')">
                    âœï¸ æˆèªå¡«ç©º
                    <div class="text-xs font-normal mt-1 text-amber-500">å¡«å…¥ç¼ºå°‘çš„å­—ï¼Œå®Œæˆæˆèª</div>
                </button>
                <button class="mode-btn w-full bg-emerald-100 text-emerald-800 hover:bg-emerald-200" onclick="startGame('story')">
                    ğŸ“š çœ‹æƒ…å¢ƒé¸æˆèª
                    <div class="text-xs font-normal mt-1 text-emerald-500">è®€ä¸€æ®µæƒ…å¢ƒï¼Œé¸å‡ºæœ€é©åˆçš„æˆèª</div>
                </button>
            </div>
        </div>

        <!-- ===== GAME SCREEN ===== -->
        <div id="game-screen" class="hidden">
            <!-- Header -->
            <div class="flex justify-between items-center mb-3">
                <div class="text-sm font-bold text-gray-500">
                    <span id="mode-label">ğŸ“– è§£é‡‹çŒœæˆèª</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm font-bold text-indigo-600" id="score-display">â­ 0</span>
                    <span class="text-sm font-bold text-gray-400" id="progress-text">1/10</span>
                </div>
            </div>
            <div class="progress-track mb-4">
                <div class="progress-fill" id="progress-bar" style="width: 10%"></div>
            </div>
            <div id="phase-text" class="text-xs font-bold text-indigo-500 mb-1">é–‹å§‹ 10 ç§’é©šå–œ</div>
            <div id="mission-text" class="text-xs font-bold text-amber-600 mb-3">æœ¬å±€ä»»å‹™ï¼šæº–å‚™ä¸­...</div>

            <!-- Question area -->
            <div id="question-area" class="mb-4"></div>

            <!-- Options area -->
            <div id="options-area" class="space-y-3"></div>
        </div>

        <!-- ===== RESULT SCREEN ===== -->
        <div id="result-screen" class="hidden text-center">
            <div class="text-6xl mb-4" id="result-emoji">ğŸ‰</div>
            <h2 class="text-2xl font-black text-gray-800 mb-2">æŒ‘æˆ°çµæŸï¼</h2>

            <div class="bg-indigo-50 rounded-2xl p-5 mb-4">
                <div class="text-sm text-gray-500 mb-1">æœ€çµ‚åˆ†æ•¸</div>
                <div class="text-5xl font-black text-indigo-600 mb-2" id="final-score">0</div>
                <div class="flex justify-center gap-4 text-sm text-gray-500">
                    <span>ç­”å° <strong class="text-green-600" id="correct-count">0</strong></span>
                    <span>æœ€é«˜é€£æ“Š <strong class="text-orange-500" id="max-combo-text">0</strong></span>
                </div>
            </div>

            <!-- Stars rating -->
            <div class="mb-4" id="stars-area">
                <span class="star">â­</span>
                <span class="star">â­</span>
                <span class="star">â­</span>
            </div>

            <p class="text-lg font-bold text-purple-600 mb-5 italic" id="result-msg">"å¤ªæ£’äº†ï¼"</p>

            <!-- Mistakes review -->
            <div id="mistakes-area" class="text-left mb-5 max-h-32 overflow-y-auto"></div>

            <div class="flex gap-3">
                <button onclick="backToMenu()" class="flex-1 py-3 rounded-xl font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                    ğŸ  é¸å–®
                </button>
                <button onclick="retryGame()" class="flex-1 py-3 rounded-xl font-bold bg-indigo-500 text-white hover:bg-indigo-600 transition-colors">
                    ğŸ”„ å†ç©ä¸€æ¬¡
                </button>
            </div>
        </div>
    </div>

    <script>
    // ============================================================
    // IDIOM DATABASE â€” 60+ common idioms for elementary students
    // ============================================================
    const IDIOM_DB = [
        // --- å‹•ç‰©é¡ ---
        { idiom: 'å®ˆæ ªå¾…å…”', meaning: 'æ¯”å–»ä¸ä¸»å‹•åŠªåŠ›ï¼Œåªæƒ³é é‹æ°£å¾—åˆ°å¥½è™•', story: 'å°æ˜ä¸è®€æ›¸ï¼Œå»å¸Œæœ›è€ƒè©¦èƒ½è€ƒä¸€ç™¾åˆ†ï¼ŒçœŸæ˜¯' },
        { idiom: 'ç•«è›‡æ·»è¶³', meaning: 'æ¯”å–»åšå¤šé¤˜çš„äº‹ï¼Œåè€ŒæŠŠäº‹æƒ…å¼„ç³Ÿ', story: 'ä½œæ–‡å·²ç¶“å¯«å¾—å¾ˆå¥½äº†ï¼Œä»–åˆåŠ äº†ä¸€å †ä¸ç›¸é—œçš„å…§å®¹ï¼Œçµæœåè€Œè®Šå·®ï¼ŒçœŸæ˜¯' },
        { idiom: 'å°ç‰›å½ˆç´', meaning: 'æ¯”å–»å°ä¸æ‡‚é“ç†çš„äººè¬›é“ç†ï¼Œç™½è²»å£èˆŒ', story: 'è·Ÿä¸€æ­²çš„å¼Ÿå¼Ÿè§£é‡‹æ•¸å­¸å…¬å¼ï¼Œæ ¹æœ¬å°±åƒæ˜¯' },
        { idiom: 'ç‹å‡è™å¨', meaning: 'æ¯”å–»è—‰è‘—æœ‰æ¬Šå‹¢çš„äººä¾†æ¬ºå£“åˆ¥äºº', story: 'ä»–æ˜æ˜åªæ˜¯çµ„é•·ï¼Œå»ä»—è‘—è€å¸«çš„åç¾©åˆ°è™•å‘½ä»¤åŒå­¸ï¼Œå°±åƒæ˜¯' },
        { idiom: 'äº•åº•ä¹‹è›™', meaning: 'æ¯”å–»è¦‹è­˜ç‹¹å°çš„äºº', story: 'ä»–å¾ä¾†æ²’å‡ºéè‡ªå·±çš„åŸå¸‚ï¼Œå°±è¦ºå¾—å…¨ä¸–ç•Œéƒ½ä¸€æ¨£ï¼ŒçœŸåƒ' },
        { idiom: 'äº¡ç¾Šè£œç‰¢', meaning: 'æ¯”å–»å‡ºäº†å•é¡Œå¾Œæƒ³è¾¦æ³•è£œæ•‘ï¼Œé‚„ä¸ç®—å¤ªæ™š', story: 'é›–ç„¶æœŸä¸­è€ƒæ²’è€ƒå¥½ï¼Œä½†ç¾åœ¨é–‹å§‹èªçœŸè®€æ›¸é‚„ä¾†å¾—åŠï¼Œæ‰€è¬‚' },
        { idiom: 'é›é£›ç‹—è·³', meaning: 'å½¢å®¹å ´é¢éå¸¸æ··äº‚ã€ä¸å¾—å®‰å¯§', story: 'å¼Ÿå¼Ÿåœ¨å®¶è£¡è¿½è‘—è²“è·‘ï¼ŒæŠŠèŠ±ç“¶ä¹Ÿæ‰“ç ´äº†ï¼Œæå¾—å®¶è£¡' },
        { idiom: 'é¶´ç«‹é›ç¾¤', meaning: 'æ¯”å–»ä¸€å€‹äººçš„æ‰èƒ½æˆ–å¤–è¡¨åœ¨çœ¾äººä¸­ç‰¹åˆ¥çªå‡º', story: 'ä»–çš„èº«é«˜åœ¨ç­ä¸Šç‰¹åˆ¥é«˜ï¼Œç«™åœ¨åŒå­¸ä¸­é–“å°±åƒ' },
        { idiom: 'é­šç›®æ··ç ', meaning: 'æ¯”å–»ç”¨å‡çš„æ±è¥¿å†’å……çœŸçš„', story: 'ä»–æ‹¿äº†ä¸€é¡†ç»ç’ƒç èªªæ˜¯çœŸçš„çç è¦è³£ï¼Œæ ¹æœ¬å°±æ˜¯' },
        { idiom: 'è™é ­è›‡å°¾', meaning: 'æ¯”å–»åšäº‹é–‹å§‹æ™‚å¾ˆæœ‰æ°£å‹¢ï¼Œå¾Œä¾†å»é¦¬è™äº†äº‹', story: 'ä»–ä¸€é–‹å§‹å¾ˆèªçœŸæ‰“æƒï¼Œå¾Œä¾†è¶Šä¾†è¶Šéš¨ä¾¿ï¼ŒçœŸæ˜¯' },
        // --- è‡ªç„¶é¡ ---
        { idiom: 'é¢¨å’Œæ—¥éº—', meaning: 'å½¢å®¹å¤©æ°£æ™´æœ—æº«æš–ï¼Œå¾®é¢¨å’Œç…¦', story: 'ä»Šå¤©å¤©æ°£çœŸå¥½ï¼Œé™½å…‰æš–æš–çš„ã€å¾®é¢¨å¹è‘—ï¼ŒçœŸæ˜¯å€‹ï¼¿ï¼¿çš„å¥½æ—¥å­', replace: true },
        { idiom: 'æ°´è½çŸ³å‡º', meaning: 'æ¯”å–»äº‹æƒ…çš„çœŸç›¸çµ‚æ–¼å¼„æ¸…æ¥šäº†', story: 'ç¶“éè€å¸«èª¿æŸ¥ï¼Œèª°å·æ‹¿äº†åŒå­¸çš„æ©¡çš®æ“¦çµ‚æ–¼' },
        { idiom: 'é›ªä¸­é€ç‚­', meaning: 'æ¯”å–»åœ¨åˆ¥äººæœ€å›°é›£çš„æ™‚å€™çµ¦äºˆå¹«åŠ©', story: 'å¥¹åœ¨æˆ‘æœ€é›£éçš„æ™‚å€™é™ªä¼´æˆ‘ã€é¼“å‹µæˆ‘ï¼ŒçœŸæ˜¯' },
        { idiom: 'ç«ä¸ŠåŠ æ²¹', meaning: 'æ¯”å–»ä½¿æƒ…æ³æ›´åŠ åš´é‡ã€ä½¿äººæ›´åŠ ç”Ÿæ°£', story: 'ä»–å€‘å·²ç¶“åœ¨åµæ¶äº†ï¼Œä½ é‚„åœ¨æ—é‚Šèªªé¢¨æ¶¼è©±ï¼Œæ ¹æœ¬å°±æ˜¯' },
        { idiom: 'ä¸€çŸ³äºŒé³¥', meaning: 'æ¯”å–»åšä¸€ä»¶äº‹èƒ½åŒæ™‚é”åˆ°å…©å€‹ç›®çš„', story: 'å»å…¬åœ’è·‘æ­¥æ—¢èƒ½é‹å‹•åˆèƒ½å‘¼å¸æ–°é®®ç©ºæ°£ï¼ŒçœŸæ˜¯' },
        // --- å­¸ç¿’é¡ ---
        { idiom: 'åŠé€”è€Œå»¢', meaning: 'æ¯”å–»åšäº‹æƒ…åšåˆ°ä¸€åŠå°±æ”¾æ£„ä¸åšäº†', story: 'ä»–å­¸é‹¼ç´æ‰å­¸äº†å…©å€‹æœˆå°±ä¸å­¸äº†ï¼Œåˆæ˜¯' },
        { idiom: 'èˆ‰ä¸€åä¸‰', meaning: 'æ¯”å–»å¾ä¸€ä»¶äº‹æƒ…å°±èƒ½æ¨æƒ³å‡ºå…¶ä»–é“ç†', story: 'å¥¹å¾ˆè°æ˜ï¼Œè€å¸«åªæ•™ä¸€é¡Œï¼Œå¥¹å°±èƒ½è§£é–‹å¾ˆå¤šé¡ä¼¼çš„é¡Œç›®ï¼ŒçœŸçš„æ˜¯' },
        { idiom: 'å‹¤èƒ½è£œæ‹™', meaning: 'åªè¦è‚¯åŠªåŠ›å‹¤å¥®ï¼Œå°±èƒ½å½Œè£œä¸è¶³ä¹‹è™•', story: 'ä»–é›–ç„¶ä¸æ˜¯æœ€è°æ˜çš„ï¼Œä½†æ¯å¤©åŠªåŠ›ç·´ç¿’ï¼Œé€²æ­¥éå¸¸å¿«ï¼Œæœç„¶æ˜¯' },
        { idiom: 'å»¢å¯¢å¿˜é£Ÿ', meaning: 'å½¢å®¹éå¸¸å°ˆå¿ƒåŠªåŠ›ï¼Œé€£ç¡è¦ºåƒé£¯éƒ½å¿˜äº†', story: 'ä»–ç‚ºäº†å®Œæˆé€™å¹…ç•«ï¼Œæ•´å¤©éƒ½æ²’åƒé£¯æ²’ç¡è¦ºï¼ŒçœŸæ˜¯' },
        { idiom: 'æº«æ•…çŸ¥æ–°', meaning: 'è¤‡ç¿’èˆŠçš„çŸ¥è­˜ï¼Œå¯ä»¥å¾—åˆ°æ–°çš„ç†è§£å’Œé«”æœƒ', story: 'è€å¸«èªªé‡æ–°çœ‹ä¸€éä»¥å‰å­¸éçš„èª²æ–‡ï¼Œæœƒæœ‰ä¸åŒçš„æ„Ÿè¦ºï¼Œæ‰€ä»¥è¦' },
        { idiom: 'ä¸æ¥ä¸‹å•', meaning: 'ä¸ä»¥å‘å­¸å•æˆ–åœ°ä½ä¸å¦‚è‡ªå·±çš„äººè«‹æ•™ç‚ºæ¥', story: 'ä»–é›–ç„¶æ˜¯ç­é•·ï¼Œä½†é‡åˆ°ä¸æœƒçš„æ•¸å­¸é¡Œé‚„æ˜¯æœƒå‘åŒå­¸è«‹æ•™ï¼ŒçœŸæ˜¯' },
        { idiom: 'ä¸‰äººè¡Œå¿…æœ‰æˆ‘å¸«', meaning: 'è·Ÿåˆ¥äººä¸€èµ·èµ°ï¼Œä¸€å®šæœ‰å¯ä»¥å­¸ç¿’çš„åœ°æ–¹', story: 'å’Œä¸åŒçš„æœ‹å‹ç›¸è™•éƒ½èƒ½å­¸åˆ°ä¸åŒçš„æ±è¥¿ï¼Œæ‰€è¬‚' },
        { idiom: 'å­¸ä»¥è‡´ç”¨', meaning: 'æŠŠå­¸åˆ°çš„çŸ¥è­˜é‹ç”¨åœ¨å¯¦éš›ç”Ÿæ´»ä¸­', story: 'ä»–æŠŠè‡ªç„¶èª²å­¸åˆ°çš„æ¤ç‰©çŸ¥è­˜ç”¨åœ¨è‡ªå·±çš„å°èŠ±åœ’è£¡ï¼ŒçœŸæ­£åšåˆ°äº†' },
        // --- åšäººåšäº‹ ---
        { idiom: 'ä¸€è«¾åƒé‡‘', meaning: 'æ¯”å–»èªªåˆ°åšåˆ°ï¼Œéå¸¸å®ˆä¿¡ç”¨', story: 'ä»–ç­”æ‡‰å€Ÿæˆ‘æ›¸å°±çœŸçš„å¸¶ä¾†äº†ï¼ŒåšäººçœŸæ˜¯' },
        { idiom: 'ä»¥èº«ä½œå‰‡', meaning: 'ç”¨è‡ªå·±çš„è¡Œå‹•åšæ¦œæ¨£çµ¦åˆ¥äººçœ‹', story: 'ç­é•·æ¯å¤©éƒ½ç¬¬ä¸€å€‹åˆ°æ•™å®¤æ‰“æƒï¼ŒçœŸçš„æ˜¯' },
        { idiom: 'åˆ»èˆŸæ±‚åŠ', meaning: 'æ¯”å–»æ‹˜æ³¥ä¸è®Šï¼Œä¸æ‡‚å¾—éš¨æ©Ÿæ‡‰è®Š', story: 'æ™‚ä»£ä¸åŒäº†ï¼Œåšæ³•ä¹Ÿè¦è·Ÿè‘—è®Šï¼Œä¸èƒ½åƒ' },
        { idiom: 'æ©è€³ç›œéˆ´', meaning: 'æ¯”å–»è‡ªå·±æ¬ºé¨™è‡ªå·±', story: 'ä»–æ˜æ˜ä½œå¼Šäº†é‚„èªªæ²’æœ‰ï¼Œä»¥ç‚ºè€å¸«ä¸çŸ¥é“ï¼Œæ ¹æœ¬å°±æ˜¯' },
        { idiom: 'ç­é–€å¼„æ–§', meaning: 'æ¯”å–»åœ¨è¡Œå®¶é¢å‰è³£å¼„æœ¬é ˜', story: 'ä»–ç«Ÿç„¶åœ¨æ›¸æ³•è€å¸«é¢å‰ç‚«è€€è‡ªå·±çš„å­—å¯«å¾—æ¼‚äº®ï¼Œæ ¹æœ¬å°±æ˜¯' },
        { idiom: 'è‡ªç›¸çŸ›ç›¾', meaning: 'æ¯”å–»è‡ªå·±çš„è¨€è¡Œå‰å¾Œä¸ä¸€è‡´', story: 'ä»–èªªä»–ä¸å–œæ­¡åƒç”œé£Ÿï¼Œçµæœæ¯å¤©éƒ½åœ¨åƒå·§å…‹åŠ›ï¼ŒçœŸæ˜¯' },
        { idiom: 'æ¨æœ¬é€æœ«', meaning: 'æ¯”å–»åšäº‹ä¸æŠ“ä¸»è¦çš„å•é¡Œï¼Œåè€Œå»æ³¨æ„ä¸é‡è¦çš„ç´°ç¯€', story: 'è€ƒè©¦å¿«åˆ°äº†ï¼Œä»–ä¸å¾©ç¿’åŠŸèª²åè€Œä¸€ç›´åœ¨æ•´ç†æ›¸æ¡Œï¼Œæ ¹æœ¬å°±æ˜¯' },
        // --- å…¶ä»–å¸¸ç”¨ ---
        { idiom: 'ä¸€èˆ‰å…©å¾—', meaning: 'åšä¸€ä»¶äº‹åŒæ™‚å¾—åˆ°å…©å€‹å¥½è™•', story: 'é¨è…³è¸è»Šä¸Šå­¸æ—¢çœéŒ¢åˆå¯ä»¥é‹å‹•ï¼ŒçœŸæ˜¯' },
        { idiom: 'ä¸‰æ€è€Œè¡Œ', meaning: 'åšäº‹æƒ…ä¹‹å‰è¦æƒ³æ¸…æ¥šå†åš', story: 'åšä»»ä½•æ±ºå®šä¹‹å‰éƒ½è¦å¥½å¥½æ€è€ƒï¼Œä¸èƒ½è¡å‹•ï¼Œè¦' },
        { idiom: 'èƒ¸æœ‰æˆç«¹', meaning: 'æ¯”å–»åšäº‹ä¹‹å‰å·²ç¶“æœ‰äº†è¨ˆç•«å’ŒæŠŠæ¡', story: 'ä»–ä¸Šå°å ±å‘Šæ™‚éå¸¸å¾å®¹è‡ªä¿¡ï¼Œçœ‹èµ·ä¾†' },
        { idiom: 'ç•°å£åŒè²', meaning: 'å¤§å®¶åŒæ™‚èªªå‡ºä¸€æ¨£çš„è©±', story: 'è€å¸«å•å¤§å®¶è¦ä¸è¦å»éƒŠéŠï¼Œå…¨ç­ï¼¿ï¼¿åœ°èªªã€Œå¥½ï¼ã€', replace: true },
        { idiom: 'ä¸€é³´é©šäºº', meaning: 'æ¯”å–»å¹³æ™‚é»˜é»˜ç„¡èçš„äººçªç„¶åšå‡ºé©šäººçš„æˆç¸¾', story: 'ä»–å¹³å¸¸ä¸å¤ªèªªè©±ï¼Œä½†åœ¨æ¼”è¬›æ¯”è³½ä¸­æ‹¿äº†ç¬¬ä¸€åï¼ŒçœŸæ˜¯' },
        { idiom: 'ä¸€ç›®äº†ç„¶', meaning: 'ä¸€çœ‹å°±å¾ˆæ¸…æ¥šæ˜ç™½', story: 'é€™å¼µåœ–è¡¨åšå¾—å¾ˆæ¸…æ¥šï¼Œè®“äºº' },
        { idiom: 'å¿ƒèŠ±æ€’æ”¾', meaning: 'å½¢å®¹å¿ƒè£¡éå¸¸é–‹å¿ƒé«˜èˆˆ', story: 'è½åˆ°è¦å»éŠæ¨‚åœ’ç©çš„æ¶ˆæ¯ï¼Œå¥¹é«˜èˆˆå¾—' },
        { idiom: 'å¤§å…¬ç„¡ç§', meaning: 'åšäº‹å…¬æ­£ï¼Œä¸åç§', story: 'ä»–ç•¶è£åˆ¤éå¸¸å…¬å¹³ï¼Œå°èª°éƒ½ä¸€æ¨£ï¼ŒçœŸæ˜¯' },
        { idiom: 'å‚é ­å–ªæ°£', meaning: 'å½¢å®¹å¤±æœ›æ²®å–ªçš„æ¨£å­', story: 'è€ƒè©¦æ²’è€ƒå¥½ï¼Œä»–ä¸€è‡‰' },
        { idiom: 'å–œå‡ºæœ›å¤–', meaning: 'é‡åˆ°å‡ºä¹æ„æ–™çš„å¥½äº‹è€Œç‰¹åˆ¥é«˜èˆˆ', story: 'ä»–æ²’æƒ³åˆ°æŠ½çå±…ç„¶ä¸­äº†å¤§çï¼ŒçœŸæ˜¯' },
        { idiom: 'æ„›ä¸é‡‹æ‰‹', meaning: 'å–œæ­¡å¾—æ¨ä¸å¾—æ”¾æ‰‹', story: 'é€™æœ¬æ¼«ç•«å¤ªå¥½çœ‹äº†ï¼Œä»–çœ‹å¾—' },
        { idiom: 'æ´¥æ´¥æœ‰å‘³', meaning: 'å½¢å®¹éå¸¸æœ‰èˆˆå‘³åœ°çœ‹æˆ–åƒ', story: 'å¥¹ä¸€é‚Šçœ‹æ•…äº‹æ›¸ä¸€é‚Šç¬‘ï¼Œçœ‹å¾—' },
        { idiom: 'è¿«ä¸åŠå¾…', meaning: 'æ€¥åˆ‡å¾—ç­‰ä¸äº†', story: 'è–èª•ç¯€çš„ç¦®ç‰©å°±åœ¨çœ¼å‰ï¼Œä»–ï¼¿ï¼¿åœ°æƒ³æ‹†é–‹', replace: true },
        { idiom: 'æç„¶å¤§æ‚Ÿ', meaning: 'çªç„¶é–“å®Œå…¨æ˜ç™½äº†', story: 'è€å¸«è§£é‡‹å®Œå¾Œï¼Œä»–çµ‚æ–¼' },
        { idiom: 'ç›®çªå£å‘†', meaning: 'å½¢å®¹éå¸¸é©šè¨ã€ç™¼æ„£çš„æ¨£å­', story: 'é­”è¡“å¸«æŠŠé´¿å­å¾å¸½å­è£¡è®Šå‡ºä¾†ï¼Œè§€çœ¾éƒ½' },
        { idiom: 'ä¸ƒå˜´å…«èˆŒ', meaning: 'å½¢å®¹å¾ˆå¤šäººåŒæ™‚æ¶è‘—èªªè©±', story: 'ä¸€ä¸‹èª²ï¼ŒåŒå­¸å€‘å°±ï¼¿ï¼¿åœ°è¨è«–èµ·é è¶³è¦å¸¶ä»€éº¼', replace: true },
        { idiom: 'æ‰‹å¿™è…³äº‚', meaning: 'å½¢å®¹éå¸¸æ…Œå¼µå¿™äº‚çš„æ¨£å­', story: 'å¿«é²åˆ°äº†ï¼Œä»–ä¸€é‚Šç©¿é‹ä¸€é‚Šæ‰¾æ›¸åŒ…ï¼Œæå¾—' },
        { idiom: 'ä¸€çŸ¥åŠè§£', meaning: 'äº†è§£å¾—ä¸å®Œå…¨ã€ä¸å¾¹åº•', story: 'ä»–ä¸Šèª²æ²’å°ˆå¿ƒè½ï¼Œæ‰€ä»¥å°é€™å€‹è§€å¿µåªæ˜¯' },
        { idiom: 'è‡ªå‘Šå¥®å‹‡', meaning: 'ä¸»å‹•ç«™å‡ºä¾†é¡˜æ„æ‰¿æ“”ä»»å‹™', story: 'éœ€è¦å¿—é¡˜è€…æ‰“æƒæ“å ´æ™‚ï¼Œä»–ï¼¿ï¼¿åœ°èˆ‰æ‰‹', replace: true },
        { idiom: 'å››é¢å…«æ–¹', meaning: 'æŒ‡å„å€‹æ–¹å‘ã€åˆ°è™•', story: 'ç…™ç«å‡ç©ºå¾Œï¼Œå…‰èŠ’ç…§å‘' },
        { idiom: 'äº”é¡å…­è‰²', meaning: 'å½¢å®¹è‰²å½©ç¹½ç´›å¤šæ¨£', story: 'èŠ±åœ’è£¡é–‹æ»¿äº†ï¼¿ï¼¿çš„èŠ±æœµï¼Œç¾æ¥µäº†', replace: true },
        { idiom: 'ä¹ç‰›ä¸€æ¯›', meaning: 'æ¯”å–»éå¸¸å°‘çš„ä¸€éƒ¨åˆ†ã€å¾®ä¸è¶³é“', story: 'é€™é»é›¶ç”¨éŒ¢å°å¯Œç¿ä¾†èªªåªæ˜¯' },
        { idiom: 'ç™¾ç™¼ç™¾ä¸­', meaning: 'å½¢å®¹å°„æ“Šæˆ–åšäº‹éå¸¸ç²¾æº–', story: 'ä»–æŠ•ç±ƒæ¯æŠ•å¿…é€²ï¼Œç°¡ç›´' },
        { idiom: 'åƒè¾›è¬è‹¦', meaning: 'å½¢å®¹ç¶“æ­·äº†å¾ˆå¤šå›°é›£å’Œè¾›è‹¦', story: 'ä»–ç¶“éï¼¿ï¼¿çš„åŠªåŠ›ï¼Œçµ‚æ–¼å­¸æœƒäº†æ¸¸æ³³', replace: true },
        { idiom: 'è¬çœ¾ä¸€å¿ƒ', meaning: 'å¤§å®¶åœ˜çµåœ¨ä¸€èµ·ï¼Œé½Šå¿ƒå”åŠ›', story: 'é¢å°å›°é›£ï¼Œå…¨ç­åŒå­¸ï¼¿ï¼¿ï¼Œä¸€èµ·è§£æ±ºäº†å•é¡Œ', replace: true },
        { idiom: 'è½èŠ±æµæ°´', meaning: 'å½¢å®¹è¢«æ‰“å¾—å¤§æ•—æˆ–æ®˜æ•—çš„æ™¯è±¡', story: 'æˆ‘å€‘çš„æ‹”æ²³éšŠæŠŠå°æ‰‹æ‰“å¾—' },
        { idiom: 'æ±å¼µè¥¿æœ›', meaning: 'å½¢å®¹åˆ°è™•çœ‹ä¾†çœ‹å»ï¼Œå¿ƒç¥ä¸å®š', story: 'ä¸Šèª²æ™‚ä»–ä¸€ç›´ï¼¿ï¼¿ï¼Œæ ¹æœ¬æ²’åœ¨è½è¬›', replace: true },
        { idiom: 'çœ‰é–‹çœ¼ç¬‘', meaning: 'å½¢å®¹éå¸¸é«˜èˆˆçš„è¡¨æƒ…', story: 'çˆ¸çˆ¸æ”¶åˆ°ç”Ÿæ—¥ç¦®ç‰©å¾Œï¼Œé«˜èˆˆå¾—' },
        { idiom: 'å·¦å³ç‚ºé›£', meaning: 'å½¢å®¹å…©é‚Šéƒ½ç‚ºé›£ï¼Œä¸çŸ¥è©²æ€éº¼é¸', story: 'å…©å€‹å¥½æœ‹å‹åŒæ™‚ç´„ä»–å‡ºå»ç©ï¼Œä»–' },
    ];

    // ============================================================
    // GAME STATE
    // ============================================================
    let state = {
        mode: '', // 'meaning' | 'fill' | 'story'
        questions: [],
        current: 0,
        score: 0,
        combo: 0,
        maxCombo: 0,
        correctCount: 0,
        mistakes: [],
        totalQuestions: 10,
        answered: false,
        questionStartAt: 0,
        gameStartAt: 0,
        mission: null,
        // fill mode state
        fillAnswer: [],
        fillBlanks: [],
    };

    // DOM
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const resultScreen = document.getElementById('result-screen');
    const comboBadge = document.getElementById('combo-badge');
    const phaseText = document.getElementById('phase-text');
    const missionText = document.getElementById('mission-text');

    function createMission() {
        const missions = [
            { id: 'correct', title: 'ç­”å° 8 é¡Œ', target: 8, progress: 0, reward: 30 },
            { id: 'combo', title: 'é”æˆ 4 é€£æ“Š', target: 4, progress: 0, reward: 40 }
        ];
        return { ...missions[Math.floor(Math.random() * missions.length)], done: false };
    }

    function updateMissionUI() {
        if (!state.mission) return;
        missionText.textContent = `æœ¬å±€ä»»å‹™ï¼š${state.mission.title} (${Math.min(state.mission.progress, state.mission.target)}/${state.mission.target})`;
    }

    function updatePhaseUI() {
        const elapsed = (performance.now() - state.gameStartAt) / 1000;
        if (elapsed <= 10) {
            phaseText.textContent = 'é–‹å§‹ 10 ç§’é©šå–œ';
        } else if (elapsed <= 40) {
            phaseText.textContent = '30 ç§’ä»»å‹™æš–èº«';
        } else if (elapsed <= 160) {
            phaseText.textContent = '120 ç§’ç²¾å½©æ™‚åˆ»';
        } else {
            phaseText.textContent = 'çµæŸçå‹µ';
        }
    }

    function markMission(type, amount = 1) {
        if (!state.mission || state.mission.done || state.mission.id !== type) return;
        state.mission.progress += amount;
        updateMissionUI();
        if (state.mission.progress >= state.mission.target) {
            state.mission.done = true;
            state.score += state.mission.reward;
            showFloat(`ä»»å‹™å®Œæˆ +${state.mission.reward}`, '#f59e0b');
        }
    }

    // ============================================================
    // UTILITY
    // ============================================================
    function shuffle(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }

    function showFloat(text, color) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.textContent = text;
        el.style.color = color;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function updateCombo() {
        if (state.combo > 1) {
            comboBadge.textContent = `COMBO x${state.combo}`;
            comboBadge.classList.add('visible');
        } else {
            comboBadge.classList.remove('visible');
        }
    }

    // ============================================================
    // GAME LOGIC
    // ============================================================
    function startGame(mode) {
        state.mode = mode;
        state.current = 0;
        state.score = 0;
        state.combo = 0;
        state.maxCombo = 0;
        state.correctCount = 0;
        state.mistakes = [];
        state.answered = false;
        state.mission = createMission();
        state.gameStartAt = performance.now();

        // Pick random idioms
        const pool = shuffle(IDIOM_DB);
        state.questions = pool.slice(0, state.totalQuestions);

        startScreen.classList.add('hidden');
        resultScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');

        const labels = { meaning: 'ğŸ“– çœ‹è§£é‡‹çŒœæˆèª', fill: 'âœï¸ æˆèªå¡«ç©º', story: 'ğŸ“š çœ‹æƒ…å¢ƒé¸æˆèª' };
        document.getElementById('mode-label').textContent = labels[mode];
        updateMissionUI();
        updatePhaseUI();

        renderQuestion();
    }

    function renderQuestion() {
        state.answered = false;
        state.questionStartAt = performance.now();
        updatePhaseUI();
        const q = state.questions[state.current];
        const idx = state.current;
        const total = state.totalQuestions;

        document.getElementById('score-display').textContent = `â­ ${state.score}`;
        document.getElementById('progress-text').textContent = `${idx + 1}/${total}`;
        document.getElementById('progress-bar').style.width = `${((idx + 1) / total) * 100}%`;

        const questionArea = document.getElementById('question-area');
        const optionsArea = document.getElementById('options-area');

        if (state.mode === 'meaning') {
            renderMeaningMode(q, questionArea, optionsArea);
        } else if (state.mode === 'story') {
            renderStoryMode(q, questionArea, optionsArea);
        } else if (state.mode === 'fill') {
            renderFillMode(q, questionArea, optionsArea);
        }
    }

    // --- MODE: Meaning (see definition, pick idiom) ---
    function renderMeaningMode(q, qArea, oArea) {
        qArea.innerHTML = `
            <div class="bg-indigo-50 rounded-2xl p-5 text-center bounce-in">
                <div class="text-sm text-indigo-400 mb-2 font-bold">é€™å¥è©±æ˜¯ä»€éº¼æˆèªï¼Ÿ</div>
                <div class="text-xl font-bold text-indigo-900 leading-relaxed">ã€Œ${q.meaning}ã€</div>
            </div>
        `;

        // Generate 4 options (1 correct + 3 wrong)
        const wrongs = shuffle(IDIOM_DB.filter(x => x.idiom !== q.idiom)).slice(0, 3);
        const options = shuffle([q, ...wrongs]);

        oArea.innerHTML = options.map((opt, i) => `
            <button class="option-btn w-full" onclick="handleMeaningAnswer(this, '${opt.idiom}', '${q.idiom}')">
                ${opt.idiom}
            </button>
        `).join('');
    }

    function handleMeaningAnswer(btn, selected, correct) {
        if (state.answered) return;
        state.answered = true;

        const allBtns = btn.parentElement.querySelectorAll('.option-btn');
        allBtns.forEach(b => b.classList.add('disabled'));

        if (selected === correct) {
            btn.classList.add('correct');
            onCorrect();
        } else {
            btn.classList.add('wrong');
            allBtns.forEach(b => {
                if (b.textContent.trim() === correct) b.classList.add('reveal');
            });
            onWrong(correct);
        }

        setTimeout(nextQuestion, 1200);
    }

    // --- MODE: Story (read scenario, pick idiom) ---
    function renderStoryMode(q, qArea, oArea) {
        qArea.innerHTML = `
            <div class="bg-emerald-50 rounded-2xl p-5 text-center bounce-in">
                <div class="text-sm text-emerald-400 mb-2 font-bold">å“ªå€‹æˆèªæœ€é©åˆï¼Ÿ</div>
                <div class="text-lg font-bold text-emerald-900 leading-relaxed">ã€Œ${q.story}ï¼¿ï¼¿ï¼¿ï¼¿ã€</div>
            </div>
        `;

        const wrongs = shuffle(IDIOM_DB.filter(x => x.idiom !== q.idiom)).slice(0, 3);
        const options = shuffle([q, ...wrongs]);

        oArea.innerHTML = options.map((opt) => `
            <button class="option-btn w-full" onclick="handleMeaningAnswer(this, '${opt.idiom}', '${q.idiom}')">
                ${opt.idiom}
            </button>
        `).join('');
    }

    // --- MODE: Fill (fill missing characters) ---
    function renderFillMode(q, qArea, oArea) {
        const chars = q.idiom.split('');
        // Remove 2 random characters as blanks
        const indices = [0, 1, 2, 3];
        const blanksIdx = shuffle(indices).slice(0, 2).sort();
        const blankedChars = chars.map((c, i) => blanksIdx.includes(i) ? null : c);
        const missingChars = blanksIdx.map(i => chars[i]);

        state.fillBlanks = blanksIdx;
        state.fillAnswer = new Array(blanksIdx.length).fill(null);

        // Extra wrong characters
        const allChars = IDIOM_DB.map(x => x.idiom.split('')).flat();
        const uniqueChars = [...new Set(allChars)].filter(c => !missingChars.includes(c));
        const wrongChars = shuffle(uniqueChars).slice(0, 4);
        const charPool = shuffle([...missingChars, ...wrongChars]);

        // Question with blanks
        qArea.innerHTML = `
            <div class="bg-amber-50 rounded-2xl p-5 text-center bounce-in">
                <div class="text-sm text-amber-500 mb-2 font-bold">å¡«å…¥æ­£ç¢ºçš„å­—å®Œæˆæˆèª</div>
                <div class="text-sm text-gray-500 mb-3">ã€Œ${q.meaning}ã€</div>
                <div class="flex justify-center gap-3" id="blank-slots">
                    ${blankedChars.map((c, i) => {
                        if (c === null) {
                            const blankIndex = blanksIdx.indexOf(i);
                            return `<div class="blank-slot" data-blank="${blankIndex}" onclick="removeFillChar(${blankIndex})"></div>`;
                        }
                        return `<div class="blank-slot filled" style="background:#fef3c7;border-color:#fbbf24;color:#92400e;cursor:default">${c}</div>`;
                    }).join('')}
                </div>
            </div>
        `;

        // Character choices
        oArea.innerHTML = `
            <div class="flex flex-wrap justify-center gap-2" id="char-pool">
                ${charPool.map((c, i) => `
                    <button class="char-btn" data-char="${c}" data-idx="${i}" onclick="selectFillChar(this, '${c}')">${c}</button>
                `).join('')}
            </div>
            <button class="w-full mt-4 py-3 rounded-xl font-bold bg-amber-500 text-white hover:bg-amber-600 transition-colors text-lg" id="fill-submit" onclick="submitFill('${q.idiom}')" style="display:none">
                âœ“ ç¢ºå®š
            </button>
        `;
    }

    function selectFillChar(btn, char) {
        if (state.answered) return;

        // Find first empty blank
        const emptyIdx = state.fillAnswer.indexOf(null);
        if (emptyIdx === -1) return;

        state.fillAnswer[emptyIdx] = { char, btnEl: btn };
        btn.classList.add('selected');
        btn.style.pointerEvents = 'none';

        // Show char in blank
        const slot = document.querySelector(`[data-blank="${emptyIdx}"]`);
        slot.textContent = char;
        slot.classList.add('filled');

        // Show submit when all filled
        if (!state.fillAnswer.includes(null)) {
            document.getElementById('fill-submit').style.display = 'block';
        }
    }

    function removeFillChar(blankIndex) {
        if (state.answered) return;
        const entry = state.fillAnswer[blankIndex];
        if (!entry) return;

        entry.btnEl.classList.remove('selected');
        entry.btnEl.style.pointerEvents = 'auto';

        state.fillAnswer[blankIndex] = null;

        const slot = document.querySelector(`[data-blank="${blankIndex}"]`);
        slot.textContent = '';
        slot.classList.remove('filled');

        document.getElementById('fill-submit').style.display = 'none';
    }

    function submitFill(correctIdiom) {
        if (state.answered) return;
        state.answered = true;

        const chars = correctIdiom.split('');
        const blanks = state.fillBlanks;
        let allCorrect = true;

        blanks.forEach((charIdx, blankIdx) => {
            const slot = document.querySelector(`[data-blank="${blankIdx}"]`);
            const entry = state.fillAnswer[blankIdx];
            if (entry && entry.char === chars[charIdx]) {
                slot.classList.add('correct');
            } else {
                slot.classList.add('wrong');
                allCorrect = false;
                // Show correct char after a moment
                setTimeout(() => {
                    slot.textContent = chars[charIdx];
                    slot.classList.remove('wrong');
                    slot.classList.add('correct');
                }, 600);
            }
        });

        // Disable all char buttons
        document.querySelectorAll('.char-btn').forEach(b => b.style.pointerEvents = 'none');
        document.getElementById('fill-submit').style.display = 'none';

        if (allCorrect) {
            onCorrect();
        } else {
            onWrong(correctIdiom);
        }

        setTimeout(nextQuestion, 1500);
    }

    // ============================================================
    // SCORING
    // ============================================================
    function onCorrect() {
        state.combo++;
        if (state.combo > state.maxCombo) state.maxCombo = state.combo;
        state.correctCount++;

        markMission('correct');
        if (state.mission?.id === 'combo' && !state.mission.done) {
            state.mission.progress = Math.max(state.mission.progress, state.combo);
            updateMissionUI();
            if (state.mission.progress >= state.mission.target) {
                state.mission.done = true;
                state.score += state.mission.reward;
                showFloat(`ä»»å‹™å®Œæˆ +${state.mission.reward}`, '#f59e0b');
            }
        }

        const multiplier = 1 + Math.floor(state.combo / 3);
        const points = 10 * multiplier;
        state.score += points;

        const answerSeconds = (performance.now() - state.questionStartAt) / 1000;
        if (answerSeconds <= 4) {
            state.score += 5;
            showFloat('å¿«é€Ÿå›ç­” +5', '#2563eb');
        }

        updateCombo();

        let msg = 'ğŸ‘';
        if (state.combo >= 3) msg = 'ğŸ”¥ å²å®³ï¼';
        if (state.combo >= 5) msg = 'âš¡ è¶…å¼·ï¼';
        if (state.combo >= 8) msg = 'ğŸŒŸ å¤©æ‰ï¼';
        showFloat(`+${points} ${msg}`, '#16a34a');
    }

    function onWrong(correctAnswer) {
        state.combo = 0;
        updateCombo();

        const q = state.questions[state.current];
        state.mistakes.push({ idiom: correctAnswer, meaning: q.meaning });

        showFloat('åŠ æ²¹ï¼', '#ef4444');
    }

    function nextQuestion() {
        state.current++;
        if (state.current >= state.totalQuestions) {
            showResults();
        } else {
            renderQuestion();
        }
    }

    // ============================================================
    // RESULTS
    // ============================================================
    function showResults() {
        gameScreen.classList.add('hidden');
        resultScreen.classList.remove('hidden');
        comboBadge.classList.remove('visible');

        document.getElementById('final-score').textContent = state.score;
        document.getElementById('correct-count').textContent = state.correctCount;
        document.getElementById('max-combo-text').textContent = state.maxCombo;

        // Stars
        const ratio = state.correctCount / state.totalQuestions;
        const starsEarned = ratio >= 0.9 ? 3 : ratio >= 0.6 ? 2 : ratio >= 0.3 ? 1 : 0;
        const starsArea = document.getElementById('stars-area');
        starsArea.innerHTML = [0, 1, 2].map(i =>
            `<span class="star ${i < starsEarned ? 'earned' : ''}" style="opacity: ${i < starsEarned ? 1 : 0.2}; animation-delay: ${i * 0.2}s">${i < starsEarned ? 'â­' : 'â˜†'}</span>`
        ).join('');

        // Emoji & message
        const emojis = ['ğŸ˜¢', 'ğŸ’ª', 'ğŸ‘', 'ğŸ‰'];
        document.getElementById('result-emoji').textContent = emojis[starsEarned];
        const msgs = [
            'åˆ¥ç°å¿ƒï¼Œå¤šç·´ç¿’å°±æœƒé€²æ­¥ï¼',
            'ä¸éŒ¯å–”ï¼Œç¹¼çºŒåŠ æ²¹ï¼',
            'åšå¾—å¾ˆå¥½ï¼Œå¿«è¦æ»¿åˆ†äº†ï¼',
            'å¤ªå²å®³äº†ï¼Œä½ æ˜¯æˆèªå¤§å¸«ï¼'
        ];
        const missionSuffix = state.mission?.done ? 'ï¼ˆæœ¬å±€ä»»å‹™å®Œæˆï¼ï¼‰' : 'ï¼ˆä¸‹æ¬¡æŒ‘æˆ°ä»»å‹™ï¼ï¼‰';
        document.getElementById('result-msg').textContent = `"${msgs[starsEarned]} ${missionSuffix}"`;

        // Mistakes review
        const mistakesArea = document.getElementById('mistakes-area');
        if (state.mistakes.length === 0) {
            mistakesArea.innerHTML = '<div class="text-center text-green-600 font-bold py-2">å…¨éƒ¨ç­”å°ï¼Œå®Œç¾ï¼âœ¨</div>';
        } else {
            mistakesArea.innerHTML = '<div class="text-sm font-bold text-gray-500 mb-2">ğŸ“ è¤‡ç¿’ä¸€ä¸‹ï¼š</div>' +
                state.mistakes.map(m =>
                    `<div class="text-sm border-b border-gray-100 py-2">
                        <span class="font-bold text-indigo-700">${m.idiom}</span>
                        <span class="text-gray-500 ml-1">â€” ${m.meaning}</span>
                    </div>`
                ).join('');
        }
    }

    function backToMenu() {
        resultScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
    }

    function retryGame() {
        startGame(state.mode);
    }
    </script>
</body>

</html>
